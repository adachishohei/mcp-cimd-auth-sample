openapi: 3.0.3
info:
  title: Authenticated MCP Server API
  description: |
    OAuth 2.1認証機能を持つModel Context Protocol (MCP) サーバーAPI。
    Client ID Metadata Documents方式を使用した認可フローと、
    JWT検証によるMCPツールへの安全なアクセスを提供します。
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: https://auth-proxy.example.com
    description: 認可プロキシサーバー
  - url: https://mcp-server.example.com
    description: MCPサーバー

tags:
  - name: Authorization
    description: OAuth 2.1認可フロー
  - name: MCP
    description: Model Context Protocolエンドポイント
  - name: Metadata
    description: メタデータエンドポイント

paths:
  /authorize:
    get:
      tags:
        - Authorization
      summary: 認可エンドポイント
      description: |
        OAuth 2.1認可コードフローの開始点。
        Client ID Metadata Documentを検証し、Cognito Managed UIにリダイレクトします。
        要件: 1.1, 1.2, 1.3, 1.4, 1.5
      operationId: authorize
      parameters:
        - name: response_type
          in: query
          required: true
          schema:
            type: string
            enum: [code]
          description: レスポンスタイプ（常に"code"）
        - name: client_id
          in: query
          required: true
          schema:
            type: string
            format: uri
            pattern: '^https://.+'
          description: Client ID Metadata DocumentのHTTPS URL
          example: https://example.com/client.json
        - name: redirect_uri
          in: query
          required: true
          schema:
            type: string
            format: uri
          description: 認可後のリダイレクト先URI
          example: http://localhost:3000/callback
        - name: code_challenge
          in: query
          required: true
          schema:
            type: string
          description: PKCE code challenge（SHA256ハッシュのBase64URL）
        - name: code_challenge_method
          in: query
          required: true
          schema:
            type: string
            enum: [S256]
          description: Code challengeメソッド（常に"S256"）
        - name: state
          in: query
          required: false
          schema:
            type: string
          description: CSRF保護用のstate値
        - name: scope
          in: query
          required: false
          schema:
            type: string
          description: 要求するスコープ（スペース区切り）
          example: mcp:tools openid
        - name: resource
          in: query
          required: false
          schema:
            type: string
            format: uri
          description: アクセス対象のリソースURI
      responses:
        '302':
          description: Cognito Managed UIへのリダイレクト
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: Cognito認証UIのURL
        '400':
          description: 不正なリクエスト
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'
              examples:
                missing_parameter:
                  value:
                    error: invalid_request
                    error_description: client_id is required
                invalid_client:
                  value:
                    error: invalid_client
                    error_description: client_id mismatch
                invalid_redirect_uri:
                  value:
                    error: invalid_request
                    error_description: redirect_uri not found in client metadata
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'

  /callback:
    get:
      tags:
        - Authorization
      summary: Cognitoコールバックエンドポイント
      description: |
        Cognito Managed UIからの認可コードを受け取り、MCPクライアントにリダイレクトします。
        このエンドポイントは、認可プロキシとMCPクライアント間の中継役として機能します。
      operationId: callback
      parameters:
        - name: code
          in: query
          required: false
          schema:
            type: string
          description: Cognitoからの認可コード
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: セッションID
        - name: error
          in: query
          required: false
          schema:
            type: string
          description: Cognitoからのエラーコード
        - name: error_description
          in: query
          required: false
          schema:
            type: string
          description: エラーの詳細説明
      responses:
        '302':
          description: MCPクライアントへのリダイレクト
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: MCPクライアントのredirect_uri（認可コード付き）
            Cache-Control:
              schema:
                type: string
                example: no-store
            Pragma:
              schema:
                type: string
                example: no-cache
        '400':
          description: 不正なリクエスト
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'

  /token:
    post:
      tags:
        - Authorization
      summary: トークンエンドポイント
      description: |
        認可コードをアクセストークンと交換します。
        PKCE検証を行い、Cognitoからトークンを取得します。
        要件: 2.1, 2.2, 2.3, 2.4, 2.5
      operationId: token
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - grant_type
                - code
                - redirect_uri
                - client_id
                - code_verifier
              properties:
                grant_type:
                  type: string
                  enum: [authorization_code]
                  description: グラントタイプ（常に"authorization_code"）
                code:
                  type: string
                  description: 認可コード
                redirect_uri:
                  type: string
                  format: uri
                  description: 認可時と同じリダイレクトURI
                client_id:
                  type: string
                  format: uri
                  description: Client ID Metadata DocumentのURL
                code_verifier:
                  type: string
                  description: PKCE code verifier
                state:
                  type: string
                  description: セッションID（認可時に生成）
      responses:
        '200':
          description: トークン発行成功
          headers:
            Cache-Control:
              schema:
                type: string
                example: no-store
            Pragma:
              schema:
                type: string
                example: no-cache
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: 不正なリクエストまたはPKCE検証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'
              examples:
                invalid_grant:
                  value:
                    error: invalid_grant
                    error_description: PKCE verification failed
                missing_parameter:
                  value:
                    error: invalid_request
                    error_description: code_verifier is required (PKCE)
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'

  /.well-known/oauth-protected-resource:
    get:
      tags:
        - Metadata
      summary: Protected Resource Metadata
      description: |
        MCPサーバーの認可情報を含むメタデータを返します。
        要件: 4.1, 4.2, 4.3, 4.4
      operationId: getProtectedResourceMetadata
      responses:
        '200':
          description: メタデータ取得成功
          headers:
            Cache-Control:
              schema:
                type: string
              description: キャッシュ制御ヘッダー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProtectedResourceMetadata'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: server_error
                  error_description:
                    type: string

  /mcp:
    post:
      tags:
        - MCP
      summary: MCPエンドポイント
      description: |
        JSON-RPC 2.0形式のMCPリクエストを処理します。
        JWT認証が必要です。
        要件: 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3
      operationId: mcpHandler
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JSONRPCRequest'
            examples:
              tools_list:
                summary: ツール一覧取得
                value:
                  jsonrpc: "2.0"
                  method: tools/list
                  id: 1
              tools_call:
                summary: ツール実行
                value:
                  jsonrpc: "2.0"
                  method: tools/call
                  params:
                    name: echo
                    arguments:
                      message: Hello, World!
                  id: 2
      responses:
        '200':
          description: MCP処理成功
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/JSONRPCSuccessResponse'
                  - $ref: '#/components/schemas/JSONRPCErrorResponse'
              examples:
                tools_list_success:
                  summary: ツール一覧レスポンス
                  value:
                    jsonrpc: "2.0"
                    result:
                      tools:
                        - name: echo
                          description: Echo back the input message
                          inputSchema:
                            type: object
                            properties:
                              message:
                                type: string
                                description: Message to echo
                            required:
                              - message
                    id: 1
                tools_call_success:
                  summary: ツール実行レスポンス
                  value:
                    jsonrpc: "2.0"
                    result:
                      content:
                        - type: text
                          text: Hello, World!
                    id: 2
                method_not_found:
                  summary: メソッド未検出エラー
                  value:
                    jsonrpc: "2.0"
                    error:
                      code: -32601
                      message: Method not found
                    id: 3
        '400':
          description: 不正なJSON-RPCリクエスト
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JSONRPCErrorResponse'
        '401':
          description: 認証失敗
          headers:
            WWW-Authenticate:
              schema:
                type: string
              description: 認証チャレンジ
              example: Bearer realm="/.well-known/oauth-protected-resource", error="invalid_token"
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: unauthorized
                  error_description:
                    type: string
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  error_description:
                    type: string

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Cognito発行のJWTアクセストークン

  schemas:
    OAuth2Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          enum:
            - invalid_request
            - invalid_client
            - invalid_grant
            - unauthorized_client
            - unsupported_grant_type
            - invalid_scope
            - server_error
          description: OAuth 2.0エラーコード
        error_description:
          type: string
          description: エラーの詳細説明
        error_uri:
          type: string
          format: uri
          description: エラー情報のURI（オプション）

    TokenResponse:
      type: object
      required:
        - access_token
        - token_type
        - expires_in
      properties:
        access_token:
          type: string
          description: アクセストークン（JWT形式）
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          enum: [Bearer]
          description: トークンタイプ
        expires_in:
          type: integer
          description: トークンの有効期限（秒）
          example: 3600
        refresh_token:
          type: string
          description: リフレッシュトークン（オプション）
        id_token:
          type: string
          description: IDトークン（オプション）
        scope:
          type: string
          description: 付与されたスコープ

    ProtectedResourceMetadata:
      type: object
      required:
        - resource
        - authorization_servers
      properties:
        resource:
          type: string
          format: uri
          description: MCPサーバーの正規URI
          example: https://mcp-server.example.com
        authorization_servers:
          type: array
          items:
            type: string
            format: uri
          description: 認可サーバーのIssuer URL
          example:
            - https://auth-proxy.example.com
        scopes_supported:
          type: array
          items:
            type: string
          description: サポートするスコープ
          example:
            - mcp:tools
            - mcp:resources
        bearer_methods_supported:
          type: array
          items:
            type: string
          description: サポートするBearer認証メソッド
          example:
            - header

    JSONRPCRequest:
      type: object
      required:
        - jsonrpc
        - method
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
          description: JSON-RPCバージョン
        method:
          type: string
          description: 呼び出すメソッド名
          example: tools/list
        params:
          type: object
          description: メソッドパラメータ（オプション）
        id:
          oneOf:
            - type: string
            - type: number
            - type: "null"
          description: リクエストID

    JSONRPCSuccessResponse:
      type: object
      required:
        - jsonrpc
        - result
        - id
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        result:
          type: object
          description: メソッド実行結果
        id:
          oneOf:
            - type: string
            - type: number
            - type: "null"

    JSONRPCErrorResponse:
      type: object
      required:
        - jsonrpc
        - error
        - id
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: integer
              description: エラーコード
              example: -32601
            message:
              type: string
              description: エラーメッセージ
              example: Method not found
            data:
              type: object
              description: 追加のエラー情報（オプション）
        id:
          oneOf:
            - type: string
            - type: number
            - type: "null"

    ClientMetadata:
      type: object
      description: Client ID Metadata Document
      required:
        - client_id
        - redirect_uris
      properties:
        client_id:
          type: string
          format: uri
          description: クライアントID（HTTPS URL）
          example: https://example.com/client.json
        client_name:
          type: string
          description: クライアント名
          example: My MCP Client
        client_uri:
          type: string
          format: uri
          description: クライアントのホームページURL
        logo_uri:
          type: string
          format: uri
          description: クライアントのロゴURL
        redirect_uris:
          type: array
          items:
            type: string
            format: uri
          description: 許可されたリダイレクトURI
          example:
            - http://localhost:3000/callback
            - https://app.example.com/callback
        grant_types:
          type: array
          items:
            type: string
          description: サポートするグラントタイプ
          example:
            - authorization_code
        response_types:
          type: array
          items:
            type: string
          description: サポートするレスポンスタイプ
          example:
            - code
        token_endpoint_auth_method:
          type: string
          enum: [none]
          description: トークンエンドポイント認証メソッド
          example: none

    MCPTool:
      type: object
      required:
        - name
        - description
        - inputSchema
      properties:
        name:
          type: string
          description: ツール名
          example: echo
        description:
          type: string
          description: ツールの説明
          example: Echo back the input message
        inputSchema:
          type: object
          description: JSON Schema形式の入力スキーマ
          properties:
            type:
              type: string
              enum: [object]
            properties:
              type: object
            required:
              type: array
              items:
                type: string

    MCPToolResult:
      type: object
      required:
        - content
      properties:
        content:
          type: array
          items:
            type: object
            required:
              - type
              - text
            properties:
              type:
                type: string
                enum: [text]
              text:
                type: string
        isError:
          type: boolean
          description: エラーかどうか
