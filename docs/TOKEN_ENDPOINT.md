# Token Endpoint Implementation

## Overview

The token endpoint (`/token`) is part of the authorization proxy and implements the OAuth 2.1 token exchange flow with PKCE validation. It exchanges an authorization code for access tokens by validating the PKCE code_verifier and calling Amazon Cognito's token endpoint.

## Endpoint Details

- **URL**: `POST /token`
- **Content-Type**: `application/x-www-form-urlencoded`
- **Requirements**: 2.1, 2.2, 2.3, 2.4, 2.5

## Request Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `grant_type` | Yes | Must be `authorization_code` |
| `code` | Yes | Authorization code from Cognito |
| `redirect_uri` | Yes | Must match the redirect_uri from authorization request |
| `client_id` | Yes | Client ID Metadata Document URL |
| `code_verifier` | Yes | PKCE code verifier (original random string) |
| `state` | Yes | Session ID passed through from authorization request |

## Request Example

```http
POST /token HTTP/1.1
Host: auth-proxy.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=AUTH_CODE_HERE&
redirect_uri=http://localhost:3000/callback&
client_id=https://example.com/client.json&
code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk&
state=abc123...
```

## Processing Flow

1. **Parse Request Body**: Extract form-encoded parameters
2. **Validate Required Parameters**: Ensure all required parameters are present
3. **Retrieve Session**: Fetch session data from DynamoDB using the state parameter
4. **Validate PKCE**: 
   - Calculate SHA256 hash of code_verifier
   - Base64URL encode the hash
   - Compare with stored code_challenge
5. **Validate Client ID**: Ensure client_id matches the session
6. **Validate Redirect URI**: Ensure redirect_uri matches the session
7. **Exchange Code**: Call Cognito's token endpoint with the authorization code
8. **Delete Session**: Remove the session from DynamoDB (one-time use)
9. **Return Tokens**: Return the tokens to the client

## Success Response

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ...",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

## Error Responses

### Invalid Request

Missing or invalid required parameters:

```json
{
  "error": "invalid_request",
  "error_description": "code_verifier is required (PKCE)"
}
```

### Invalid Grant

Session not found, PKCE validation failed, or parameter mismatch:

```json
{
  "error": "invalid_grant",
  "error_description": "PKCE verification failed"
}
```

### Cognito Error

Error from Cognito token endpoint:

```json
{
  "error": "invalid_grant",
  "error_description": "Failed to exchange code for tokens: Invalid authorization code"
}
```

## PKCE Validation

The PKCE validation process ensures that the client that initiated the authorization request is the same client exchanging the code for tokens.

### Algorithm

1. Calculate SHA256 hash of code_verifier:
   ```
   hash = SHA256(code_verifier)
   ```

2. Base64URL encode the hash:
   ```
   calculated_challenge = base64url(hash)
   ```

3. Compare with stored code_challenge:
   ```
   if (calculated_challenge === stored_code_challenge) {
     // Valid
   } else {
     // Invalid - return error
   }
   ```

### Example

```javascript
// Original code_verifier (generated by client)
const codeVerifier = "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk";

// Calculate code_challenge (done by client during authorization)
const hash = crypto.createHash('sha256').update(codeVerifier).digest();
const codeChallenge = hash
  .toString('base64')
  .replace(/\+/g, '-')
  .replace(/\//g, '_')
  .replace(/=/g, '');
// Result: "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM"

// During token exchange, server recalculates and compares
```

## Session Management

### Session Storage

Sessions are stored in DynamoDB with the following structure:

```json
{
  "sessionId": "abc123...",
  "code_challenge": "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM",
  "code_challenge_method": "S256",
  "client_id": "https://example.com/client.json",
  "redirect_uri": "http://localhost:3000/callback",
  "state": "xyz123",
  "created_at": 1234567890,
  "ttl": 1234568490
}
```

### Session Lifecycle

1. **Created**: During authorization request processing
2. **Retrieved**: During token exchange
3. **Deleted**: After successful token exchange (one-time use)
4. **Expired**: Automatically after 10 minutes (TTL)

## Security Considerations

1. **PKCE Mandatory**: OAuth 2.1 requires PKCE for all public clients
2. **One-Time Use**: Sessions are deleted after successful token exchange
3. **Parameter Validation**: All parameters are validated against the session
4. **Session TTL**: Sessions expire after 10 minutes
5. **No Client Secret**: Public clients don't use client secrets (PKCE provides security)

## Integration with Cognito

The token endpoint acts as a proxy to Cognito's token endpoint:

```
Client → Auth Proxy /token → Cognito /oauth2/token → Auth Proxy → Client
```

This allows the auth proxy to:
- Validate PKCE before calling Cognito
- Validate client_id and redirect_uri against the session
- Provide consistent error responses
- Track token exchanges

## Testing

See `src/auth-proxy/__tests__/token.test.ts` for unit tests covering:
- Parameter validation
- PKCE validation
- Session validation
- Error handling
- Successful token exchange

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `SESSION_TABLE_NAME` | DynamoDB table for sessions | `mcp-auth-sessions` |
| `COGNITO_DOMAIN` | Cognito domain prefix | `mcp-auth-123456789012` |
| `COGNITO_CLIENT_ID` | Cognito User Pool Client ID | `abc123...` |
| `COGNITO_REGION` | AWS region | `us-east-1` |

## Related Documentation

- [Authorization Endpoint](./AUTHORIZE_ENDPOINT.md)
- [Authorization Flow Example](./AUTHORIZATION_FLOW_EXAMPLE.md)
- [Cognito Setup](./COGNITO_SETUP.md)
