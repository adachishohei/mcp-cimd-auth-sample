# 実装計画

- [x] 1. プロジェクト構造とAWS環境のセットアップ
  - プロジェクトディレクトリ構造を作成
  - AWS CDKまたはSAMの初期化
  - 必要な依存関係のインストール
  - _要件: すべて_

- [x] 2. Amazon Cognito User Poolの設定
  - Cognito User Poolを作成
  - Managed UIを有効化
  - OAuth 2.1設定（PKCE必須）
  - テストユーザーの作成
  - _要件: 3.1, 3.2, 3.4_

- [ ]* 2.1 Cognito統合テストの作成
  - Managed UIへのリダイレクトテスト
  - トークン発行テスト
  - _要件: 3.3, 3.4_

- [x] 3. 認可プロキシ - 認可エンドポイントの実装
  - API Gatewayで/authorizeエンドポイントを作成
  - Lambda関数を実装
  - Client ID Metadata Document取得機能
  - client_id検証ロジック
  - redirect_uri検証ロジック
  - セッション管理（DynamoDB）
  - Cognito Managed UIへのリダイレクト
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 3.1 プロパティテスト: Client ID Metadata Document取得
  - **プロパティ1: Client ID Metadata Document取得**
  - **検証: 要件 1.2**

- [ ]* 3.2 プロパティテスト: client_id一致検証
  - **プロパティ2: client_id一致検証**
  - **検証: 要件 1.3**

- [ ]* 3.3 プロパティテスト: redirect_uri検証
  - **プロパティ3: redirect_uri検証**
  - **検証: 要件 1.4**

- [ ]* 3.4 プロパティテスト: 認可成功時のリダイレクト
  - **プロパティ4: 認可成功時のリダイレクト**
  - **検証: 要件 1.5**

- [x] 4. 認可プロキシ - トークンエンドポイントの実装
  - API Gatewayで/tokenエンドポイントを作成
  - Lambda関数を実装
  - PKCE検証ロジック
  - Cognitoトークンエンドポイント呼び出し
  - トークンレスポンスの返却
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ]* 4.1 プロパティテスト: PKCE検証
  - **プロパティ5: PKCE検証**
  - **検証: 要件 2.2, 2.5**

- [ ]* 4.2 プロパティテスト: PKCE成功時のトークン取得
  - **プロパティ6: PKCE成功時のトークン取得**
  - **検証: 要件 2.3, 2.4**

- [x] 5. MCPサーバー - Protected Resource Metadataエンドポイントの実装
  - API Gatewayで/.well-known/oauth-protected-resourceエンドポイントを作成
  - Lambda関数を実装
  - メタデータJSONの生成
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ]* 5.1 ユニットテスト: Protected Resource Metadata構造
  - メタデータの必須フィールド検証
  - _要件: 4.2, 4.3, 4.4_

- [x] 6. MCPサーバー - JWT検証ミドルウェアの実装
  - Authorizationヘッダーの抽出
  - CognitoのJWKS取得
  - JWT署名検証
  - クレーム検証（issuer, audience, expiration）
  - エラーハンドリング（401レスポンス）
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 6.1 プロパティテスト: 未認証リクエストの拒否
  - **プロパティ7: 未認証リクエストの拒否**
  - **検証: 要件 5.1, 6.4**

- [ ]* 6.2 プロパティテスト: WWW-Authenticateヘッダーの構造
  - **プロパティ8: WWW-Authenticateヘッダーの構造**
  - **検証: 要件 5.2**

- [ ]* 6.3 プロパティテスト: JWT検証
  - **プロパティ9: JWT検証**
  - **検証: 要件 5.3**

- [ ]* 6.4 プロパティテスト: 有効なトークンの処理
  - **プロパティ10: 有効なトークンの処理**
  - **検証: 要件 5.4**

- [ ]* 6.5 プロパティテスト: 無効なトークンの拒否
  - **プロパティ11: 無効なトークンの拒否**
  - **検証: 要件 5.5**

- [x] 7. MCPサーバー - MCPプロトコルハンドラーの実装
  - JSON-RPC 2.0パーサー
  - tools/listハンドラー
  - tools/callハンドラー
  - サンプルツール（echoツール）の実装
  - _要件: 6.1, 6.2, 6.3_

- [ ]* 7.1 プロパティテスト: ツールリストの返却
  - **プロパティ12: ツールリストの返却**
  - **検証: 要件 6.2**

- [ ]* 7.2 プロパティテスト: ツール実行
  - **プロパティ13: ツール実行**
  - **検証: 要件 6.3**

- [x] 8. 環境変数と設定管理
  - 環境変数の定義
  - AWS Systems Manager Parameter StoreまたはSecrets Managerの使用
  - 設定検証ロジック
  - _要件: すべて_

- [x] 9. デプロイとインフラストラクチャ
  - AWS CDK/SAMテンプレートの完成
  - CI/CDパイプラインの設定
  - デプロイスクリプトの作成
  - _要件: すべて_

- [x] 10. ドキュメントとREADME
  - セットアップ手順
  - 環境変数の説明
  - デプロイ手順
  - 使用例
  - _要件: すべて_

- [x] 11. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する
